# name: CI Workflow for the Assessment Project

# on:
#   push:
#     branches:
#       - main  # This ensures the workflow only triggers on push to main

# jobs:
#   Init_and_test:
#     name: Init and Test
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout Code
#       uses: actions/checkout@v4

#     - name: Setup Node
#       uses: actions/setup-node@v4
#       with:
#         node-version: 20.12.1
#         cache: npm

#     - name: Initialise npm
#       run: npm ci

#     - name: Perform Static Analysis with ESLint
#       run: npx eslint -o eslint_report.json -f json
#       continue-on-error: true

#     - name: Create ESLint Annotations
#       uses: ataylorme/eslint-annotate-action@v3
#       with:
#         only-pr-files: false

#     - name: Run Jest Tests
#       run: npm test



name: CI/CD Workflow for the Assessment Project

on:
  push:
    branches:
      - main  # Trigger only on push to main

jobs:
  init_test_and_deploy:
    name: Init, Test, and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.12.1
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Perform Static Analysis with ESLint
      run: npx eslint -o eslint_report.json -f json
      continue-on-error: true

    - name: Create ESLint Annotations
      uses: ataylorme/eslint-annotate-action@v3
      with:
        only-pr-files: false

    - name: Run Unit Tests with Jest
      run: npm test

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker Image (Test Image)
      run: |
        docker build -f Dockerfiles/test.Dockerfile -t ${{ secrets.DOCKER_USERNAME }}/earnest-thomas-intro-to-devops-a2:test-latest .

    - name: Push Docker Image to Docker Hub
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/earnest-thomas-intro-to-devops-a2:test-latest
